var XWiki=(function(d){var c=d.importer=d.importer||{};var b={availableDocuments:"$services.localization.render('core.importer.availableDocuments')",importHistoryLabel:"$services.localization.render('core.importer.importHistory')",selectionEmpty:"$services.localization.render('core.importer.selectionEmptyWarning')","import":"$services.localization.render('core.importer.import')","package":"$services.localization.render('core.importer.package')",description:"$services.localization.render('core.importer.package.description')",version:"$services.localization.render('core.importer.package.version')",licence:"$services.localization.render('core.importer.package.licence')",author:"$services.localization.render('core.importer.package.author')",documentSelected:"$services.localization.render('core.importer.documentSelected')",whenDocumentAlreadyExists:"$services.localization.render('core.importer.whenDocumentAlreadyExists')",addNewVersion:"$services.localization.render('core.importer.addNewVersion')",replaceDocumentHistory:"$services.localization.render('core.importer.replaceDocumentHistory')",resetHistory:"$services.localization.render('core.importer.resetHistory')",importAsBackup:"$services.localization.render('core.importer.importAsBackup')",select:"$services.localization.render('core.importer.select')",all:"$services.localization.render('core.importer.selectAll')",none:"$services.localization.render('core.importer.selectNone')"};var a=function(){$$("#packagelistcontainer a.package").invoke("observe","click",function(g){var e=g.element(),f=e.href.substring(e.href.indexOf("&file=")+6);g.stop();$$("div#packagelistcontainer div.active").invoke("removeClassName","active");g.element().up("div.package").addClassName("active");new c.PackageExplorer("packagecontainer",decodeURIComponent(f))});$$("#packagelistcontainer .deletelink").invoke("observe","click",function(e){e.stop();new d.widgets.ConfirmedAjaxRequest(e.findElement("a").href,{onSuccess:function(){if(e.element().up("div.active")){$("packagecontainer").update()}e.findElement("li").remove()}},{confirmationText:"$services.localization.render('core.viewers.attachments.delete.confirm')"})})};if(!browser.isIE6x){document.observe("xwiki:dom:loaded",function(){a();var f=$("AddAttachment");if(f&&typeof(d.FileUploader)!="undefined"){var e=new d.FileUploader(f.down("input[type='file']"),{progressAutohide:true,responseContainer:$("packagelistcontainer"),responseURL:window.docgeturl+"?xpage=packagelist&forceTestRights=1"});f.observe("xwiki:html5upload:done",a);e.hideFormButtons()}})}Element.addMethods("input",{uncheck:function(e){e=$(e);e.checked=false;return e},check:function(e){e=$(e);e.checked=true;return e}});c.PackageInformationRequest=Class.create({initialize:function(h,g){this.name=h;this.successCallback=g.onSuccess||function(){};this.failureCallback=g.onFailure||function(){};var f=window.docgeturl+"?xpage=packageinfo&package="+encodeURIComponent(h);var e=new Ajax.Request(f,{onSuccess:this.onSuccess.bindAsEventListener(this),on1223:this.on1223.bindAsEventListener(this),on0:this.on0.bindAsEventListener(this),onFailure:this.onFailure.bind(this)})},on1223:function(e){e.request.options.onSuccess(e)},on0:function(e){e.request.options.onFailure(e)},onSuccess:function(e){this.successCallback(e)},onFailure:function(e){this.failureCallback(e)}});c.PackageExplorer=Class.create({initialize:function(g,f){this.node=$(g);this.name=f;this.ignore={};this.documentCount={};this.node.addClassName("loading");var e=new c.PackageInformationRequest(f,{onSuccess:this.onPackageInfosAvailable.bind(this),onFailure:this.onPackageInfosRequestFailed.bind(this)})},onPackageInfosAvailable:function(h){this.node.removeClassName("loading");this.node.update();if(this.node.empty()){this.node.insert(new Element("h4",{"class":"legend"}).update(b.availableDocuments))}var f=h.responseText.evalJSON();this.infos=f.infos;this.packageDocuments=f.files;this.container=new Element("div",{id:"packageDescription"});this.node.insert(this.container);this.container.insert(this.createPackageHeader(f.infos));var e=new Element("span").update(b.none);e.observe("click",this.onIgnoreAllDocuments.bind(this));var g=new Element("span").update(b.all);g.observe("click",this.onRestoreAllDocuments.bind(this));this.container.insert(new Element("div",{"class":"selectLinks"}).insert(b.select).insert(e).insert(", ").insert(g));this.list=new Element("ul",{"class":"xlist package"});this.container.insert(new Element("div",{id:"package"}).update(this.list));Object.keys(this.packageDocuments).sort().each(this.addSpaceToPackage.bind(this));this.container.insert(this.createPackageFormSubmit(f.infos));this.container.down("div.packagesubmit input[type=radio]").checked=true},onIgnoreAllDocuments:function(){this.container.select("input[type=checkbox][class=space]").invoke("uncheck");this.container.select("input[type=checkbox][class=space]").invoke("fire","custom:click")},onRestoreAllDocuments:function(){this.container.select("input[type=checkbox][class=space]").invoke("check");this.container.select("input[type=checkbox][class=space]").invoke("fire","custom:click")},onPackageInfosRequestFailed:function(f){this.node.update();var e="Failed to retrieve package information. Reason: ";if(f.statusText==""||response.status==12031){e+="Server not responding"}else{e+=f.statusText}this.node.removeClassName("loading");this.node.update(new Element("div",{"class":"errormessage"}).update(e))},createPackageFormSubmit:function(j){var i=new Element("div",{"class":"packagesubmit"});i.insert(new Element("em").update(b.whenDocumentAlreadyExists));var g=new Element("input",{type:"radio",name:"historyStrategy",checked:"checked",value:"add"});i.insert(new Element("div",{"class":"historyStrategyOption"}).insert(g).insert(b.addNewVersion));i.insert(new Element("div",{"class":"historyStrategyOption"}).insert(new Element("input",{type:"radio",name:"historyStrategy",value:"replace"})).insert(b.replaceDocumentHistory));i.insert(new Element("div",{"class":"historyStrategyOption"}).insert(new Element("input",{type:"radio",name:"historyStrategy",value:"reset"})).insert(b.resetHistory));if(d.hasBackupPackImportRights){var e=new Element("input",{type:"checkbox",name:"importAsBackup",value:"true"});if(j.backup){e.checked=true}i.insert(new Element("div",{"class":"importOption"}).insert(e).insert(b.importAsBackup))}var h=new Element("span",{"class":"buttonwrapper"});var f=new Element("input",{type:"submit",value:b["import"],"class":"button"});f.observe("click",this.onPackageSubmit.bind(this));h.insert(f);i.insert(h);return i},onPackageSubmit:function(){if(this.countSelectedDocuments()==0){var m=new Element("span",{"class":"warningmessage"}).update(b.selectionEmpty);if(!$("packagecontainer").down("div.packagesubmit span.warningmessage")){$("packagecontainer").select("div.packagesubmit input").last().insert({after:m});Element.remove.delay(5,m)}return}var o={};o.action="import";o.name=this.name;o.historyStrategy=$("packageDescription").down("input[type=radio][value='add']").checked?"add":($("packageDescription").down("input[type=radio][value='replace']").checked?"replace":"reset");if(d.hasBackupPackImportRights){o.importAsBackup=$("packageDescription").down("input[type=checkbox][name='importAsBackup']").checked?"true":"false"}o.ajax="1";var f=[];var k=Object.keys(this.packageDocuments);for(var h=0;h<k.length;h++){var e=this.packageDocuments[k[h]];var l=Object.keys(e);for(var g=0;g<l.length;g++){var n=e[l[g]];n.each(function(j){if(!this.isIgnored(k[h],l[g],j.language)){var i=j.fullName+":"+j.language;f.push(i);o["language_"+i]=j.language}}.bind(this))}}o.pages=f;this.node.update();this.node.addClassName("loading");this.node.setStyle("min-height:200px");new Ajax.Request(window.location,{method:"post",parameters:o,onSuccess:function(i){$("packagecontainer").removeClassName("loading");$("packagecontainer").update(i.responseText)},onFailure:function(j){var i="Failed to import documents. Reason: ";if(j.statusText==""||j.status==12031){i+="Server not responding"}else{i+=j.statusText}$("packagecontainer").removeClassName("loading");$("packagecontainer").update(new Element("div",{"class":"errormessage"}).update(i))}})},createPackageHeader:function(f){var e=new Element("div",{"class":"packageinfos"});e.insert(new Element("div").insert(new Element("span",{"class":"label"}).update(b["package"])).insert(new Element("span",{"class":"filename"}).update(this.name)));if(f.name!==""){e.insert(new Element("div").insert(new Element("span",{"class":"label"}).update(b.description)).insert(new Element("span",{"class":"name"}).update(f.name)))}if(f.version!==""){e.insert(new Element("div").insert(new Element("span",{"class":"label"}).update(b.version)).insert(new Element("span",{"class":"version"}).update(f.version)))}if(f.author!==""){e.insert(new Element("div").insert(new Element("span",{"class":"label"}).update(b.author)).insert(new Element("span",{"class":"author"}).update(f.author)))}if(f.licence!==""){e.insert(new Element("div").insert(new Element("span",{"class":"label"}).update(b.licence)).insert(new Element("span",{"class":"licence"}).update(f.licence)))}return e},addSpaceToPackage:function(e){var l=this.countDocumentsInSpace(e);var n=l+" / "+l+" "+b.documentSelected;var g=new Element("li",{"class":"xitem xunderline collapsed"});var h=new Element("div",{"class":"xitemcontainer"});var j=new Element("input",{type:"checkbox",checked:"checked","class":"space"});j.observe("click",function(p){j.fire("custom:click",p.memo)}.bind(this));j.observe("custom:click",this.spaceCheckboxClicked.bind(this));h.insert(j);var i=new Element("div",{"class":"spacename"}).update(e);h.insert(i);var k=function(p){p.element().up("li").toggleClassName("collapsed")};i.observe("click",k);h.insert(new Element("div",{"class":"selection"}).update(n));h.insert(new Element("div",{"class":"clearfloats"}));var f=new Element("div",{"class":"pages"});var m=new Element("ul",{"class":"xlist pages"});var o=this;Object.keys(this.packageDocuments[e]).sort().each(function(p){o.addDocumentToSpace(m,e,p)});f.update(m);h.insert(f);g.insert(h);this.list.insert(g);j.checked=true},addDocumentToSpace:function(i,h,g){var f=this.packageDocuments[h][g],e=this;f.sortBy(function(j){return j.language}).each(function(m){var k=new Element("li",{"class":"xitem xhighlight"});var j=new Element("div",{"class":"xitemcontainer xpagecontainer"});var l=new Element("input",{type:"checkbox",checked:"checked"});l.observe("click",e.documentCheckboxClicked.bind(e));j.insert(new Element("span",{"class":"checkbox"}).update(l));j.insert(new Element("span",{"class":"documentName"}).update(g));if(m.language!=""){j.insert(new Element("span",{"class":"documentLanguage"}).update(" - "+m.language))}j.insert(new Element("div",{"class":"clearfloats"}));k.insert(new Element("div",{"class":"fullName hidden"}).update(m.fullName));k.insert(new Element("div",{"class":"language hidden"}).update(m.language));k.insert(j);i.insert(k);l.checked=true})},countDocumentsInSpace:function(f){var e=this;if(typeof this.documentCount[f]=="undefined"){this.documentCount[f]=Object.keys(this.packageDocuments[f]).inject(0,function(h,g){return h+e.packageDocuments[f][g].length})}delete e;return this.documentCount[f]},countSelectedDocumentsInSpace:function(f){var g;if(typeof this.ignore[f]=="undefined"){return this.countDocumentsInSpace(f)}else{var e=this;return(this.countDocumentsInSpace(f)-Object.keys(this.ignore[f]).inject(0,function(i,h){return i+e.ignore[f][h].length}))}},countSelectedDocuments:function(){var e=this;return Object.keys(this.packageDocuments).inject(0,function(g,f){return g+e.countSelectedDocumentsInSpace(f)})},updateSelection:function(e,f){var h=this.countDocumentsInSpace(f);var g=this.countSelectedDocumentsInSpace(f);e.down(".selection").update(g+" / "+h+" "+b.documentSelected);if(g==0){e.down("input.space").uncheck()}else{e.down("input.space").check()}},spaceCheckboxClicked:function(h){var g=h.element().checked;var f=h.element().up(".xitemcontainer").down(".spacename").innerHTML;var e=h.element().up(".xitemcontainer").down("div.pages");if(!g){this.ignoreSpace(f);e.select("input[type='checkbox']").invoke("uncheck")}else{this.restoreSpace(f);e.select("input[type='checkbox']").invoke("check")}this.updateSelection(h.element().up(".xitemcontainer"),f)},documentCheckboxClicked:function(f){var h=f.element().up("div").down("span.documentName").innerHTML.stripTags().strip();var g=f.element().up("li").up("div.xitemcontainer").down(".spacename").innerHTML;var i=f.element().up("li").down(".language").innerHTML;var e=f.element().checked;if(!e){this.ignoreDocument(g,h,i)}else{this.restoreDocument(g,h,i)}this.updateSelection(f.element().up("li").up("div.xitemcontainer"),g)},isIgnored:function(f,g,h){if(typeof this.ignore[f]=="undefined"){return false}if(typeof this.ignore[f][g]=="undefined"){return false}for(var e=0;e<this.ignore[f][g].length;e++){if(this.ignore[f][g][e].language==h){return true}}return false},ignoreSpace:function(e){this.ignore[e]=Object.toJSON(this.packageDocuments[e]).evalJSON()},restoreSpace:function(e){if(typeof this.ignore[e]!="undefined"){delete this.ignore[e]}},ignoreDocument:function(e,f,g){if(typeof this.ignore[e]=="undefined"){this.ignore[e]=new Object()}if(typeof this.ignore[e][f]=="undefined"){this.ignore[e][f]=[]}this.ignore[e][f][this.ignore[e][f].length]={language:g}},restoreDocument:function(e,g,h){if(typeof this.ignore[e]!="undefined"&&typeof this.ignore[e][g]!="undefined"){for(var f=0;f<this.ignore[e][g].length;f++){if(this.ignore[e][g][f].language===h){delete this.ignore[e][g][f];this.ignore[e][g]=this.ignore[e][g].compact()}}}}});return d})(XWiki||{});