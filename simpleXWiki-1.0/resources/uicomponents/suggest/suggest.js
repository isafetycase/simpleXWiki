var XWiki=(function(b){var a=b.widgets=b.widgets||{};if(typeof a.XList=="undefined"){if(typeof console!="undefined"&&typeof console.warn=="function"){console.warn("[Suggest widget] Required class missing: XWiki.widgets.XList")}}else{a.Suggest=Class.create({options:{minchars:1,method:"get",varname:"input",className:"ajaxsuggest",timeout:2500,delay:500,offsety:0,shownoresults:true,noresults:"$services.localization.render('core.widgets.suggest.noResults')",maxheight:250,cache:false,seps:"",icon:null,resultsParameter:"results",resultId:"id",resultValue:"value",resultInfo:"info",resultIcon:"icon",resultHint:"hint",parentContainer:"body",highlight:true,fadeOnClear:true,hideButton:{positions:["top"],text:"$escapetool.javascript($services.localization.render('core.widgets.suggest.hide'))"},insertBeforeSuggestions:null,displayValue:false,displayValueText:"$services.localization.render('core.widgets.suggest.valuePrefix')",align:"left",unifiedLoader:false,loaderNode:null},sInput:"",nInputChars:0,aSuggestions:[],iHighlighted:null,isActive:false,initialize:function(c,d){if(!c){return false}this.setInputField(c);this.options=Object.extend(Object.clone(this.options),d||{});if(typeof this.options.sources=="object"){this.sources=this.options.sources}else{this.sources=this.options}this.sources=[this.sources].flatten().compact();if(!$(this.options.parentContainer)){this.options.parentContainer=$(document.body)}if(this.options.seps){this.seps=this.options.seps}else{this.seps=""}this.latestRequest=0},setInputField:function(c){this.detach();this.fld=$(c);if(this.fld.__x_suggest){this.fld.__x_suggest.detach()}this.fld.__x_suggest=this;this.onKeyUp=this.onKeyUp.bindAsEventListener(this);this.fld.observe("keyup",this.onKeyUp);this.onKeyPress=this.onKeyPress.bindAsEventListener(this);if(Prototype.Browser.IE||Prototype.Browser.WebKit){this.fld.observe("keydown",this.onKeyPress)}else{this.fld.observe("keypress",this.onKeyPress)}this.fld.setAttribute("autocomplete","off");this.fld.observe("blur",function(d){this.latestRequest++}.bind(this))},onKeyUp:function(f){var d=f.keyCode;switch(d){case Event.KEY_RETURN:case Event.KEY_ESC:case Event.KEY_UP:case Event.KEY_DOWN:break;default:if(this.seps){var e=-1;for(var c=0;c<this.seps.length;c++){if(this.fld.value.lastIndexOf(this.seps.charAt(c))>e){e=this.fld.value.lastIndexOf(this.seps.charAt(c))}}if(e==-1){this.getSuggestions(this.fld.value)}else{this.getSuggestions(this.fld.value.substring(e+1))}}else{this.getSuggestions(this.fld.value)}}},onKeyPress:function(d){if(!$(this.isActive)){return}var c=d.keyCode;switch(c){case Event.KEY_RETURN:if(!this.iHighlighted&&this.aSuggestions.length==1){this.highlightFirst()}this.setHighlightedValue();Event.stop(d);break;case Event.KEY_ESC:this.clearSuggestions();Event.stop(d);break;case Event.KEY_UP:this.changeHighlight(c);Event.stop(d);break;case Event.KEY_DOWN:this.changeHighlight(c);Event.stop(d);break;default:break}},getSuggestions:function(g){g=g.strip().toLowerCase();if(g==this.sInput){return false}if(g.length<this.options.minchars){this.sInput="";this.clearSuggestions();return false}if(g.length>this.nInputChars&&this.aSuggestions.length&&this.options.cache){var c=[];for(var d=0;d<this.aSuggestions.length;d++){if(this.aSuggestions[d].value.substr(0,g.length).toLowerCase()==g){c.push(this.aSuggestions[d])}}this.sInput=g;this.nInputChars=g.length;this.aSuggestions=c;this.createList(this.aSuggestions);return false}else{this.sInput=g;this.nInputChars=g.length;this.prepareContainer();this.latestRequest++;var f=this;var e=this.latestRequest;clearTimeout(this.ajID);this.container.select(".hide-button-wrapper").invoke("hide");this.ajID=setTimeout(function(){f.doAjaxRequests(e)},this.options.delay)}return false},doAjaxRequests:function(h,f){if(this.fld.value.length<this.options.minchars){return}for(var e=0;e<this.sources.length;e++){var g=this.sources[e];var d=g.script+(g.script.indexOf("?")<0?"?":"&")+g.varname+"="+encodeURIComponent(this.fld.value.strip());var k=g.method||"get";var j={};if(g.json){j.Accept="application/json"}else{j.Accept="application/xml"}var c={method:k,requestHeaders:j,onCreate:this.fld.addClassName.bind(this.fld,"loading"),onSuccess:this.setSuggestions.bindAsEventListener(this,g,h),onFailure:function(i){new b.widgets.Notification("$services.localization.render('core.widgets.suggest.transportError')"+i.statusText,"error",{timeout:5})},onComplete:this.fld.removeClassName.bind(this.fld,"loading")};c.defaultValues=Object.clone(c);new Ajax.Request(d,Object.extend(c,f||{}))}},setSuggestions:function(d,e,f){if(f<this.latestRequest){return}var c=this.parseResponse(d,e);this.aSuggestions=c||[];c&&this.createList(this.aSuggestions,e)},parseResponse:function(g,h){var c=[];if(h.json){var j=g.responseJSON;if(!j){return null}var f=j[h.resultsParameter||this.options.resultsParameter];for(var e=0;e<f.length;e++){c.push({id:f[e][h.resultId||this.options.resultId],value:f[e][h.resultValue||this.options.resultValue],info:f[e][h.resultInfo||this.options.resultInfo],icon:f[e][h.resultIcon||this.options.resultIcon],hint:f[e][h.resultHint||this.options.resultHint]})}}else{var d=g.responseXML;var f=d.getElementsByTagName(h.resultsParameter||this.options.resultsParameter)[0].childNodes;for(var e=0;e<f.length;e++){if(f[e].hasChildNodes()){c.push({id:f[e].getAttribute("id"),value:f[e].childNodes[0].nodeValue,info:f[e].getAttribute("info"),icon:f[e].getAttribute("icon"),hint:f[e].getAttribute("hint")})}}}return c},prepareContainer:function(){if(!$(this.options.parentContainer).down(".suggestItems")){var e=new Element("div",{"class":"suggestItems "+this.options.className});var p=$(this.options.parentContainer).tagName.toLowerCase()=="body"?this.fld.cumulativeOffset():this.fld.positionedOffset();var h=this.fld.offsetWidth-2;var r=this.options.width||h;if(this.options.align=="left"){e.style.left=p.left+"px"}else{if(this.options.align=="center"){e.style.left=p.left+(h-r)/2+"px"}else{e.style.left=(p.left+h-r)+"px"}}e.style.top=(p.top+this.fld.offsetHeight+this.options.offsety)+"px";e.style[this.options.width?"width":"minWidth"]=r+"px";var c=this;e.onmouseover=function(){c.killTimeout()};e.onmouseout=function(){c.resetTimeout()};this.resultContainer=new Element("div",{"class":"resultContainer"});e.appendChild(this.resultContainer);$(this.options.parentContainer).insert(e);this.container=e;if(this.options.insertBeforeSuggestions){this.resultContainer.insert(this.options.insertBeforeSuggestions)}document.fire("xwiki:suggest:containerCreated",{container:this.container,suggest:this})}if(this.sources.length>1){for(var j=0;j<this.sources.length;j++){var d=this.sources[j];d.id=j;if(this.resultContainer.down(".results"+d.id)){if(this.resultContainer.down(".results"+d.id).down("ul")){this.resultContainer.down(".results"+d.id).down("ul").remove()}if(!this.options.unifiedLoader){this.resultContainer.down(".results"+d.id).down(".sourceContent").addClassName("loading")}else{(this.options.loaderNode||this.fld).addClassName("loading");this.resultContainer.down(".results"+d.id).addClassName("hidden").addClassName("loading")}}else{var s=new Element("div",{"class":"results results"+d.id}),q=new Element("div",{"class":"sourceName"});if(this.options.unifiedLoader){s.addClassName("hidden").addClassName("loading")}if(typeof d.icon!="undefined"){var o=new Image();o.onload=function(){this.sourceHeader.setStyle({backgroundImage:"url("+this.iconImage.src+")"});this.sourceHeader.setStyle({textIndent:(this.iconImage.width+6)+"px"})}.bind({sourceHeader:q,iconImage:o});o.src=d.icon}q.insert(d.name);s.insert(q);var f="sourceContent "+(this.options.unifiedLoader?"":"loading");s.insert(new Element("div",{"class":f}));if(typeof d.before!=="undefined"){this.resultContainer.insert(d.before)}this.resultContainer.insert(s);if(typeof d.after!=="undefined"){this.resultContainer.insert(d.after)}}}}else{if(this.resultContainer.down("ul")){this.resultContainer.down("ul").remove()}}var n=typeof this.options.hideButton!=="undefined"&&typeof this.options.hideButton.positions==="object"&&this.options.hideButton.positions.length>0;if(n&&!this.container.down(".hide-button")){var g=this.options.hideButton.positions;for(var j=0;j<g.length;j++){var k=new Element("span",{"class":"hide-button"}).update(this.options.hideButton.text),l={};l[g[j]]=new Element("div",{"class":"hide-button-wrapper"}).update(k);k.observe("click",this.clearSuggestions.bindAsEventListener(this));this.container.insert(l)}}var m=this.container.fire("xwiki:suggest:containerPrepared",{container:this.container,suggest:this});return this.container},createList:function(c,d){this._createList(c,d);if(this.sources.length==1||!this.resultContainer.down(".results.loading")){document.fire("xwiki:suggest:updated",{container:this.container,suggest:this})}},_createList:function(f,d){this.isActive=true;var c=this;this.killTimeout();if(this.sources.length>1){var j=this.resultContainer.down(".results"+d.id);j.removeClassName("loading");j.down(".sourceContent").removeClassName("loading");(f.length>0||this.options.shownoresults)&&j.removeClassName("hidden");if(this.options.unifiedLoader&&!this.resultContainer.down(".results.loading")){(this.options.loaderNode||this.fld).removeClassName("loading")}}else{var j=this.resultContainer}if(f.length==0&&!this.options.shownoresults){return false}j.down("ul")&&j.down("ul").remove();this.container.select(".hide-button-wrapper").invoke("show");var h=new b.widgets.XList([],{icon:this.options.icon,classes:"suggestList",eventListeners:{click:function(){c.setHighlightedValue();return false},mouseover:function(){c.setHighlight(this.getElement())}}});for(var e=0,g=f.length;e<g;e++){var m=function(i){return((i||"")+"").escapeHTML()};var k=new Element("div").insert(new Element("span",{"class":"suggestId"}).update(m(f[e].id))).insert(new Element("span",{"class":"suggestValue"}).update(m(f[e].value))).insert(new Element("span",{"class":"suggestInfo"}).update(m(f[e].info)));var l=new b.widgets.XListItem(this.createItemDisplay(f[e],d),{containerClasses:"suggestItem",value:k,noHighlight:true});h.addItem(l)}if(f.length==0){h.addItem(new b.widgets.XListItem(this.options.noresults,{classes:"noSuggestion",noHighlight:true}))}j.appendChild(h.getElement());this.suggest=j;var c=this;if(this.options.timeout>0){this.toID=setTimeout(function(){c.clearSuggestions()},this.options.timeout)}},createItemDisplay:function(f,c){var h=this.sInput?this.sInput.escapeHTML():this.sInput;var k=((f.value||"")+"").escapeHTML();var e=c.highlight?this.emphasizeMatches(h,k):k;if(f.hint){var d=(f.hint+"").escapeHTML();e+="<span class='hint'>"+d+"</span>"}if(!this.options.displayValue){var j=new Element("span",{"class":"info"}).update(e)}else{var i=((f.info||"")+"").escapeHTML();var j=new Element("div").insert(new Element("div",{"class":"value"}).update(e)).insert(new Element("div",{"class":"info"}).update("<span class='legend'>"+this.options.displayValueText+"</span>"+i))}if(f.icon){var g=new Element("img",{src:f.icon,"class":"icon"});j.insert({top:g})}return j},emphasizeMatches:function(k,m){if(!k){return m}var c=m,i=k.split(" ").uniq().compact(),d=0,g={};for(var e=0,n=i.length;e<n;e++){var h=c.toLowerCase().indexOf(i[e].toLowerCase());while(h>=0){var f=c.substring(h,h+i[e].length),l="";i[e].length.times(function(){l+=" "});g[h]=f;c=c.substring(0,h)+l+c.substring(h+i[e].length);h=c.toLowerCase().indexOf(i[e].toLowerCase())}}Object.keys(g).sortBy(function(j){return parseInt(j)}).each(function(j){var o=c.substring(0,parseInt(j)+d);var p=c.substring(parseInt(j)+g[j].length+d);c=o+"<em>"+g[j]+"</em>"+p;d+=9});return c},changeHighlight:function(c){var f=this.resultContainer;if(!f){return false}var g,d;if(this.iHighlighted){if(c==Event.KEY_DOWN){d=this.iHighlighted.next();if(!d&&this.iHighlighted.up("div.results")){var e=this.iHighlighted.up("div.results").next();while(e&&!d){d=e.down("li");e=e.next()}}if(!d){d=f.down("li")}}else{if(c==Event.KEY_UP){d=this.iHighlighted.previous();if(!d&&this.iHighlighted.up("div.results")){var e=this.iHighlighted.up("div.results").previous();while(e&&!d){d=e.down("li:last-child");e=e.previous()}}if(!d){d=f.select("ul")[f.select("ul").length-1].down("li:last-child")}}}}else{if(c==Event.KEY_DOWN){if(f.down("div.results")){d=f.down("div.results").down("li")}else{d=f.down("li")}}else{if(c==Event.KEY_UP){if(f.select("li")>0){d=f.select("li")[f.select("li").length-1]}}}}if(d){this.setHighlight(d)}},setHighlight:function(c){if(this.iHighlighted){this.clearHighlight()}c.addClassName("xhighlight");this.iHighlighted=c;this.killTimeout()},clearHighlight:function(){if(this.iHighlighted){this.iHighlighted.removeClassName("xhighlight");delete this.iHighlighted}},highlightFirst:function(){if(this.suggest&&this.suggest.down("ul")){var c=this.suggest.down("ul").down("li");if(c){this.setHighlight(c)}}},hasActiveSelection:function(){return this.iHighlighted},setHighlightedValue:function(){if(this.iHighlighted&&!this.iHighlighted.hasClassName("noSuggestion")){var m=function(i){return i.textContent||i.innerText};var j=this.iHighlighted.down("img.icon");var f={suggest:this,id:m(this.iHighlighted.down(".suggestId")),value:m(this.iHighlighted.down(".suggestValue")),info:m(this.iHighlighted.down(".suggestInfo")),icon:j?j.src:""};var k,l;if(this.sInput==""&&this.fld.value==""){k=l=f.value}else{if(this.seps){var d=-1;for(var g=0;g<this.seps.length;g++){if(this.fld.value.lastIndexOf(this.seps.charAt(g))>d){d=this.fld.value.lastIndexOf(this.seps.charAt(g))}}if(d==-1){k=l=f.value}else{l=this.fld.value.substring(0,d+1)+f.value;k=l.substring(d+1)}}else{k=l=f.value}}var c=Event.fire(this.fld,"xwiki:suggest:selected",Object.clone(f));if(!c.stopped){this.sInput=k;this.fld.value=l;this.fld.focus();this.clearSuggestions();typeof this.options.callback=="function"&&this.options.callback(Object.clone(f));if(this.fld.id.indexOf("_suggest")>0){var e=this.fld.id.substring(0,this.fld.id.indexOf("_suggest"));var h=$(e);if(h){h.value=f.info}}}}},killTimeout:function(){clearTimeout(this.toID)},resetTimeout:function(){clearTimeout(this.toID);var c=this;this.toID=setTimeout(function(){c.clearSuggestions()},1000)},clearSuggestions:function(){this.clearHighlight();this.killTimeout();this.isActive=false;var c=$(this.container);var e=this;if(c&&c.parentNode){if(this.options.fadeOnClear){var d=new Effect.Fade(c,{duration:"0.25",afterFinish:function(){if($(e.container)){$(e.container).remove()}}})}else{$(this.container).remove()}document.fire("xwiki:suggest:clearSuggestions",{suggest:this})}},detach:function(){if(this.fld){Event.stopObserving(this.fld,"keyup",this.onKeyUp);if(Prototype.Browser.IE||Prototype.Browser.WebKit){Event.stopObserving(this.fld,"keydown",this.onKeyPress)}else{Event.stopObserving(this.fld,"keypress",this.onKeyPress)}this.clearSuggestions();this.fld.__x_suggest=null;this.fld.setAttribute("autocomplete","on")}}})}return b})(XWiki||{});