var XWiki=(function(c){c.ExtensionBehaviour=Class.create({initialize:function(d){this.finalize();this.container=d;this.container._extensionBehaviour=this;this._fixExtensionLinks();this._enhanceActions();this._enhanceMenuBehaviour();this._enhanceDescriptionBehaviour();this._enhanceDependenciesBehaviour();this._enhanceProgressBehaviour();this._maybeScheduleRefresh()},finalize:function(){if(this.container){delete this.container._extensionBehaviour;this.container.remove()}this.container=undefined},getNamespace:function(){var d=this.container.down('input[name="extensionNamespace"]');return d?d.value:null},getId:function(){var d=this.container.down('input[name="extensionId"]');return d?d.value:null},getVersion:function(){var d=this.container.down('input[name="extensionVersion"]');return d?d.value:null},getStatus:function(){var e=$w(this.container.className);for(var d=0;d<e.length;d++){if(e[d].startsWith("extension-item-")){return e[d].substr(15)}}return null},_getServiceURL:function(e){if(e){e=c.getResource(e);e=new c.Document(e.name,e.space,e.wiki)}else{e=c.currentDocument}var d=c.contextaction=="view"||c.contextaction=="admin"?"get":c.contextaction;return e.getURL(d)},_onAjaxRequestFailure:function(d){if(d.status==401){new c.widgets.ConfirmationBox({onYes:function(){window.location.reload(true)}},{confirmationText:"$escapetool.javascript($services.localization.render('extensions.info.fetch.unauthorized'))"});return false}else{var e=d.statusText;if(d.statusText==""||d.status==12031){e="Server not responding"}new c.widgets.Notification("$escapetool.javascript($services.localization.render('extensions.info.fetch.failed'))"+e,"error");return true}},_submit:function(g,e){g.stop();var f=g.element().form;var h=new Hash(f.serialize({submit:false}));h.set(g.element().name,g.element().value);f.disable();var d={parameters:h,onFailure:this._onAjaxRequestFailure.bind(this),on0:function(i){i.request.options.onFailure(i)},onComplete:function(){f.enable()}};d.defaultValues=Object.clone(d);new Ajax.Request(this._getServiceURL(h.get("section")),Object.extend(d,e))},_update:function(h){var g=this.container.down(".extension-body");var i=!g||g.hasClassName("hidden");var e=this.container.down(".innerMenu li a.current");e&&(this._previouslySelectedMenuItem=e.getAttribute("href"));var d=this.getStatus();this.container.addClassName("hidden");this.container.insert({after:h});this.initialize(this.container.next());var j=this.container.down(".extension-body");var f=!j||j.hasClassName("hidden");i&&!f&&this._onToggleShowHideDetails({stop:function(){},element:function(){return this.container.down('button[value="hideDetails"]')}.bind(this)});if(d!=this.getStatus()){document.fire("xwiki:extension:statusChanged",{extension:this})}document.fire("xwiki:dom:updated",{elements:[this.container]})},_onShowDetails:function(d){this._submit(d,{onCreate:function(){this.container.insert({bottom:new Element("div",{"class":"extension-body loading"})})}.bind(this),onSuccess:function(e){this._update(e.responseText)}.bind(this),onComplete:function(e){e.request.options.defaultValues.onComplete(e);var f=this.container.down(".extension-body.loading");f&&f.remove()}.bind(this)})},_enhanceShowDetailsBehaviour:function(){var e=this.container.down('button[value="showDetails"]');if(!e){return}if(e.hasClassName("visibilityAction")){e=e.up();var d=this.container.down('button[value="hideDetails"]').up();e.__otherButton=d;d.__otherButton=e;this.container.select(".visibilityAction").invoke("observe","click",this._onToggleShowHideDetails.bindAsEventListener(this));e.remove()}else{e.observe("click",this._onShowDetails.bindAsEventListener(this))}},_onToggleShowHideDetails:function(e){e.stop();var d=e.element().up("span");this.container.down(".extension-body").toggleClassName("hidden");d.replace(d.__otherButton)},_enhanceActions:function(){this._enhanceShowDetailsBehaviour();var d=this._startJob.bindAsEventListener(this);this.container.select('button[name="extensionAction"]').each(function(e){if(!e.value.endsWith("Details")){e.observe("click",d)}})},_onBeforeStartJob:function(){var d=this.container.down(".extension-body");if(d){d.hasClassName("hidden")&&this._onToggleShowHideDetails({stop:function(){},element:function(){return this.container.down('button[value="showDetails"]')}.bind(this)});var e=this._prepareProgressSectionForLoading();this._activateMenuItem(d.down('.innerMenu li a[href="#'+e.previous().id+'"]'))}else{this.container.insert({bottom:new Element("div",{"class":"extension-body loading"})})}},_prepareProgressSectionForLoading:function(){var g=this.container.down(".extension-body-progress");if(!g){var e=this.container.select(".extension-body-section").last();g=new Element("div",{"class":"extension-body-progress extension-body-section loading"});e.insert({after:g});var d="extension-body-progress"+e.previous().id.substr($w(e.className)[0].length);e.insert({after:new Element("div",{id:d})});var h="$escapetool.javascript($services.localization.render('extensions.info.category.progress'))";var f=new Element("a",{href:"#"+d}).update(h);this._enhanceMenuItemBehaviour(f);this.container.down(".innerMenu").insert(new Element("li").insert(f))}else{if(g.down(".extension-log-item-loading")){g.down(".extension-question").hide()}else{g.childElements().invoke("hide");g.addClassName("loading")}}return g},_onAfterStartJob:function(e){e.request.options.defaultValues.onComplete(e);var d=this.container.down(".extension-body.loading");if(d){d.remove()}else{this._restoreProgressSection()}},_restoreProgressSection:function(){var d=this.container.down(".extension-body-progress");if(d){d.childElements().invoke("show");d.removeClassName("loading")}},_startJob:function(d){this._submit(d,{onCreate:this._onBeforeStartJob.bind(this),onSuccess:function(e){this._update(e.responseText)}.bind(this),onComplete:this._onAfterStartJob.bind(this)})},refresh:function(d){this.container.addClassName("extension-item-loading");this._refresh(d);this.container.disable()},_refresh:function(e){var d=new Hash(this.container.serialize({submit:false}));e&&d.update(e);this._preserveMenuSelection=true;new Ajax.Request(this._getServiceURL(d.get("section")),{parameters:d,onSuccess:function(f){this._update(f.responseText)}.bind(this),onFailure:function(f){if(this._onAjaxRequestFailure(f)){this._maybeScheduleRefresh(10)}}.bind(this),on0:function(f){f.request.options.onFailure(f)}})},_maybeScheduleRefresh:function(d){d=d||1;this.container.hasClassName("extension-item-loading")&&!this.container.down('button[value="continue"]')&&this._refresh.bind(this).delay(d)},_enhanceMenuBehaviour:function(){var e=".innerMenu li a";var d=this.container.down(e+".current");if(!d||this._preserveMenuSelection){if(this._previouslySelectedMenuItem){d=this.container.down(e+'[href="'+this._previouslySelectedMenuItem+'"]')}else{if(!d){d=this.container.down(e)}}}this._preserveMenuSelection=false;if(d){this._activateMenuItem(d);this.container.select(e).each(this._enhanceMenuItemBehaviour,this)}},_enhanceMenuItemBehaviour:function(d){d.observe("click",function(e){e.stop();this._activateMenuItem(e.element())}.bindAsEventListener(this))},_activateMenuItem:function(e){this.container.select(".extension-body-section").invoke("setStyle",{display:"none"});var d=this.container.down(".innerMenu li a.current");if(d){d.removeClassName("current")}$(e.getAttribute("href").substring(1)).next(".extension-body-section").setStyle({display:"block"});e.addClassName("current")},_fixExtensionLinks:function(d){(d||this.container).select("a.extension-link").each(function(e){var f=e.getAttribute("href").replace(/.*\?/,"");e.setAttribute("href",c.currentDocument.getURL(c.contextaction,f))})},_enhanceProgressBehaviour:function(){this.container.select(".extension-log-item").each(function(f){var g=f.down(".stacktrace");if(g){g.toggle();var h=f.down("div");h.setStyle({cursor:"pointer"});h.observe("click",function(){g.toggle()})}});var d=this.container.down(".extension-log-item-loading");if(d){var e=d.up();e.scrollTop=e.scrollHeight}},_enhanceDependenciesBehaviour:function(){if(!this.container.hasClassName("extension-item-loading")){this._resolveUnknownDependency(this.container.select(".dependency-item.extension-item-unknown"),0)}},_resolveUnknownDependency:function(f,e){if(e>=f.length){return}var g=new Hash(this.container.serialize({submit:false}));g.unset("extensionVersion");g.unset("form_token");var d=f[e];g.set("extensionId",d.down(".extension-name").innerHTML);g.set("extensionVersionConstraint",d.down(".extension-version").innerHTML);new Ajax.Request(this._getServiceURL(g.get("section")),{parameters:g,onCreate:function(){d.removeClassName("extension-item-unknown").addClassName("extension-item-loading")},onSuccess:function(h){if(d.up("html")){d.insert({before:h.responseText});this._fixExtensionLinks(d.previous());d.remove();this._resolveUnknownDependency(f,e+1)}}.bind(this),onFailure:function(h){d.removeClassName("extension-item-loading").addClassName("extension-item-unknown");this._onAjaxRequestFailure(h)}.bind(this),on0:function(h){h.request.options.onFailure(h)}})},_enhanceDescriptionBehaviour:function(){var d=this.container.down(".extension-versions-link");d&&d.observe("click",function(e){e.stop();e.element().hide().up().addClassName("loading").setStyle({height:"16px",width:"16px"});this._refresh({listVersions:true})}.bindAsEventListener(this))}});c.ExtensionSearchFormBehaviour=Class.create({initialize:function(){this._enhanceSimpleSearch();this._enhanceAdvancedSearch()},_enhanceSimpleSearch:function(){var d=$("extension-search-simple");if(!d){return}$("extensionSearchRepositoryList").observe("change",function(f){$("extensionSearchInput").focus();var e=f.element().form;e.submit.bind(e).defer()}.bindAsEventListener(this))},_enhanceAdvancedSearch:function(){var g=$("extension-search-advanced");if(!g){return}var d=g.down("legend a");if(d){var f=d.up("legend").next().next();if(f){d.observe("click",function(h){h.stop();d.blur();f.toggleClassName("hidden");d.toggleClassName("expanded")});var e=f.down("a.actionCancel");if(e){e.observe("click",function(h){h.stop();e.up("form").select("input[type=text]").each(function(i){i.value=""});d.click()})}}}}});c.ExtensionUpdaterBehaviour=Class.create({initialize:function(d){this.container&&this.container.remove();this.container=d;var e=this.container.down(".checkForUpdates");e&&e.observe("click",this._onCheckForUpdates.bindAsEventListener(this));this._maybeScheduleRefresh()},_maybeScheduleRefresh:function(d){this.container&&this.container.childElements().any(function(e){return e.hasClassName("ui-progress")})&&this._refresh.bind(this).delay(d||1)},_refresh:function(d){d=d||{};new Ajax.Request(this._getRefreshURL(),{parameters:d,onSuccess:function(e){this.container.addClassName("hidden").insert({after:e.responseText});this.initialize(this.container.next());document.fire("xwiki:dom:updated",{elements:[this.container]});this.container.childElements().each(function(h){if(h.hasClassName("extension-body-progress")){var f=h.down(".extension-log-item-loading");if(f){var g=f.up();g.scrollTop=g.scrollHeight}}})}.bind(this),onFailure:this._maybeScheduleRefresh.bind(this,10)})},_getRefreshURL:function(){var f=window.location.href.toQueryParams().section;var d=c.currentDocument;var h;if(f){var g=c.getResource(f);d=new c.Document(g.name,g.space,g.wiki);h="section="+encodeURIComponent(f)}var e=c.contextaction=="view"||c.contextaction=="admin"?"get":c.contextaction;return d.getURL(e,h)},_onCheckForUpdates:function(d){d.stop();this._refresh({action:"checkForUpdates",xredirect:this._getRefreshURL()})}});var a=function(d){((d&&d.memo.elements)||[$("body")]).each(function(e){e.select(".extension-item").each(function(f){!f._extensionBehaviour&&new c.ExtensionBehaviour(f)})})};var b=function(d){$("extensionUpdater")&&new c.ExtensionUpdaterBehaviour($("extensionUpdater"));new c.ExtensionSearchFormBehaviour();a(d);return true};(c.domIsLoaded&&b())||document.observe("xwiki:dom:loaded",b);document.observe("xwiki:dom:updated",a);return c}(XWiki||{}));