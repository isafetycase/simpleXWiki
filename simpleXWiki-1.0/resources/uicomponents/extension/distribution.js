var XWiki=(function(d){d.DefaultUIStep=Class.create({initialize:function(){document.observe("xwiki:extension:statusChanged",this._onExtensionStatusChanged.bindAsEventListener(this));this._maybeEnhancePreviousUiForm()},_onExtensionStatusChanged:function(g){var f=$("stepButtons")&&$("stepButtons").select("button");if(!f){return}var h=g.memo.extension;var e=h.getStatus();if(e=="loading"){f.invoke("disable")}else{f.invoke("enable");if(h.getId()=="$services.distribution.getUIExtensionId().id"&&h.getVersion()=="$services.distribution.getUIExtensionId().version.value"){this._onDefaultUiExtensionStatusChanged(f,e)}else{if(this._previousUiExtensionId&&h.getId()==this._previousUiExtensionId.id&&h.getVersion()==this._previousUiExtensionId.version){this._onPreviousUiExtensionStatusChanged(e)}}}},_onDefaultUiExtensionStatusChanged:function(f,e){if(e=="installed"){f[0].up().removeClassName("hidden");f[1].up().addClassName("hidden");f[2].up().addClassName("hidden")}else{f[0].up().addClassName("hidden");f[1].up().removeClassName("hidden");f[2].up().removeClassName("hidden")}},_maybeEnhancePreviousUiForm:function(){var j=$("previousUi");if(!j){return}j.down(".button").observe("click",this._resolvePreviousUiExtension.bindAsEventListener(this));var f=j.down(".button.secondary");f.up().removeClassName("hidden");var g=this._hidePreviousUiForm.bindAsEventListener(this);f.observe("click",g);this._enhancePreviousUiInput();var e=j.previous().removeClassName("hidden");e.down(".button").observe("click",function(k){k.stop();e.hide();j.enable().show().focusFirstElement()}).activate();e.down(".button.secondary").observe("click",g);j.hide();var h=$("stepButtons").up("form");var i=j.next();while(i&&i!=h){i=i.hide().next()}},_enhancePreviousUiInput:function(){var e=new Element("input",{type:"image","class":"icon",src:'$xwiki.getSkinFile("icons/silk/pencil.png")',alt:"$escapetool.javascript($services.localization.render('platform.extension.distributionWizard.uiStepPreviousUIAdvancedInputHint'))",title:"$escapetool.javascript($services.localization.render('platform.extension.distributionWizard.uiStepPreviousUIAdvancedInputHint'))"});var g=$("previousUiId");var h=$("previousUiVersion");var f=$("previousUiVersionList");f.up("dd").removeClassName("hidden").previous().removeClassName("hidden");h.up("dd").hide().previous().hide();g.hide().up("dd").previous().down(".xHint").hide();g.insert({after:e}).insert({after:new Element("span")});g.up("dd").hide().previous().hide();f.observe("change",this._onSelectPreviousUiVersion.bind(this));e.observe("click",this._switchToAdvancedPreviousUiInput.bindAsEventListener(this))},_onSelectPreviousUiVersion:function(){var f=$("previousUiId");f.up("dd").show().previous().show();var e=$("previousUiVersionList");$("previousUiVersion").value=e.options[e.selectedIndex].value;if(e.selectedIndex==0){var g=""}else{if(e.length==102){if(e.selectedIndex<27){var g="org.xwiki.manager:xwiki-manager-ui"}else{if(e.selectedIndex<38){var g="org.xwiki.manager:xwiki-manager-wiki-administrator"}else{if(e.selectedIndex<46){var g="org.xwiki.manager:xwiki-enterprise-manager-wiki-administrator"}else{var g="com.xpn.xwiki.products:xwiki-enterprise-manager-wiki-administrator"}}}}else{if(e.selectedIndex<27){var g="org.xwiki.enterprise:xwiki-enterprise-ui"}else{if(e.selectedIndex<53){var g="org.xwiki.enterprise:xwiki-enterprise-wiki"}else{var g="com.xpn.xwiki.products:xwiki-enterprise-wiki"}}}}f.value=g;f.next().update(g)},_switchToAdvancedPreviousUiInput:function(e){e.stop();e.element().hide().previous().hide();$("previousUiId").show().activate().up("dd").previous().down(".xHint").show();$("previousUiVersion").up("dd").show().previous().show();$("previousUiVersionList").up("dd").hide().previous().hide()},_hidePreviousUiForm:function(g){g&&g.stop();var f=$("previousUi");f.hide().previous().hide();for(var e=f.next();e;e=e.show().next()){}},_resolvePreviousUiExtension:function(f){f.stop();var e=$("previousUi");var g=e.serialize(true);new Ajax.Request(e.action,{parameters:{extensionId:g.previousUiId,extensionVersion:g.previousUiVersion,hideExtensionDetails:true},onCreate:function(){e.disable();var h=e.down(".buttons").next();h&&h.remove()},onSuccess:function(i){var h=new Element("div").update(i.responseText);var j=h.down(".extension-item");if(j){if(j.down('button[name="extensionAction"][value="install"]')){this._previousUiExtensionId={id:g.previousUiId,version:g.previousUiVersion};this._displayPreviousUiExtension(j)}else{this._hidePreviousUiForm()}}else{e.enable().insert(h)}}.bind(this),on0:function(h){h.request.options.onFailure(h)},onFailure:function(){e.enable();new d.widgets.Notification("$escapetool.javascript($services.localization.render('platform.extension.distributionWizard.uiStepPreviousUIRequestFailed'))","error")}})},_displayPreviousUiExtension:function(g){var f=$("previousUi");var h=new Element("div",{"class":"xHint"}).update("$escapetool.javascript($services.localization.render('platform.extension.distributionWizard.uiStepPreviousUIHint'))".escapeHTML());var e=new Element("div").insert(h).insert(g);f.hide().insert({after:e});document.fire("xwiki:dom:updated",{elements:[e]});var i=g.down('button[name="extensionAction"][value="install"]');i.update("$escapetool.javascript($services.localization.render('platform.extension.distributionWizard.uiStepPreviousUIRepairLabel'))".escapeHTML());i.title="$escapetool.javascript($services.localization.render('platform.extension.distributionWizard.uiStepPreviousUIRepairHint'))";i.value="repairXAR";i.activate();i.insert({after:new Element("input",{type:"hidden",name:"form_token",value:document.head.down('meta[name="form_token"]').readAttribute("content")})})},_onPreviousUiExtensionStatusChanged:function(e){if(e=="installed"){var h=$("previousUi");h.next().remove();for(var g=h.next();g;g=g.show().next()){}var f=h.next(".xform").previous().down(".extension-item");f&&f._extensionBehaviour.refresh({hideExtensionDetails:true})}}});var b=Class.create({initialize:function(){this.container=$("distributionWizard");document.observe("xwiki:extension:statusChanged",this._updateStepButtons.bind(this));document.observe("xwiki:dom:updated",function(e){e.memo.elements.each(function(f){f.down(".extension-item")&&this._updateStepButtons()}.bind(this))}.bindAsEventListener(this))},_updateStepButtons:function(){var e=$("stepButtons");if(!e){return}e=e.select("button");if(this.container.down(".extension-item.extension-item-loading")||this.container.down(".extension-log-item-loading")){e.invoke("disable");this._disable&&this._disable()}else{e.invoke("enable");this._enable&&this._enable();if(this._isCompleted&&this._isCompleted()){e[0].up().removeClassName("hidden");e[1].up().addClassName("hidden");e[2].up().addClassName("hidden")}else{e[0].up().addClassName("hidden");e[1].up().removeClassName("hidden");e[2].up().removeClassName("hidden")}}}});d.OutdatedExtensionsStep=Class.create(b,{_enable:function(){var e=this.container.down(".checkForUpdates");e&&e.up(".xHint").show()},_disable:function(){var e=this.container.down(".checkForUpdates");e&&e.up(".xHint").hide()},_isCompleted:function(){var f=0;var e=0;this.container.select(".invalidExtensions").each(function(h){var g=h.childElements();f+=g.size();e+=g.filter(function(i){return i.hasClassName("extension-item-installed")}).size()});return e==f}});var a=Class.create(b,{_isCompleted:function(){var e=this.container.down("dl").childElements().length/2;var g=this.container.select(".extension-item");if(e!=g.length){return false}for(var f=0;f<g.length;f++){if(!g[f].hasClassName("extension-item-installed")){return false}}return true}});function c(){$("extension.defaultui")&&new d.DefaultUIStep();$("extension.defaultui.wikis")&&new a();$("extension.outdatedextensions")&&new d.OutdatedExtensionsStep();return true}(d.domIsLoaded&&c())||document.observe("xwiki:dom:loaded",c);return d}(XWiki||{}));